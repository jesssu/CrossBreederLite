#!/system/bin/sh

export PATH=/system/etc/CrossBreeder:/system/bin:/system/xbin:/sbin:/vendor/bin:/system/sbin

alias [='busybox ['
alias [[='busybox [['

ALL="$(busybox cat /data/CrossBreeder/zzCheck_Net_DNS/ALL)"
GOOGLEDNS="$(busybox cat /data/CrossBreeder/zzCheck_Net_DNS/GOOGLEDNS)"
DNSTURN="$(busybox cat /data/CrossBreeder/zzCheck_Net_DNS/DNSTURN)"

set +e

if [ "$ALL" = "1" ]; then

if [ "$DNSTURN" = "1" ]; then

CB_Check_Net_DNS 2>/dev/null
pid=$!

busybox renice +20 $pid 2>/dev/null
busybox nice -n +20 rinetd -c /data/CrossBreeder/zzCheck_Net_DNS/CONF >/dev/null 2>&1

fi

if [ "$GOOGLEDNS" = "1" ]; then

iptables -t nat -I OUTPUT -p tcp --dport 53 -j DNAT --to-destination 8.8.8.8:53
iptables -t nat -I OUTPUT -p udp --dport 53 -j DNAT --to-destination 8.8.8.8:53

setprop net.dns1 8.8.8.8
setprop net.dns2 8.8.4.4
setprop net.rmnet0.dns1 8.8.8.8
setprop net.rmnet0.dns2 8.8.4.4
setprop net.gprs.dns1 8.8.8.8
setprop net.gprs.dns2 8.8.4.4
setprop net.ppp0.dns1 8.8.8.8
setprop net.ppp0.dns2 8.8.4.4
setprop net.wlan0.dns1 8.8.8.8
setprop net.wlan0.dns2 8.8.4.4
setprop net.eth0.dns1 8.8.8.8
setprop net.eth0.dns2 8.8.4.4

fi

if [ "$DNSTURN" = "1" ]; then

ANDROID_DNS_MODE= dnsmasq_dhcp -d --server=/bit/178.63.16.21,/bit/95.211.195.245,/bit/178.32.31.41 -n --user=root -x /dev/dnsmasq.pid -a 127.0.0.3 -z -p 10053 -c 0 -N -h -S 8.8.8.8 -S 8.8.4.4 2>/dev/null
pid=$!
busybox renice +20 $pid 2>/dev/null

if [ ! -e /dev/socket/dnsproxyd.bak ]; then
  dnsproxy2 -w 127.0.0.1 2>/dev/null
fi

fi
fi
