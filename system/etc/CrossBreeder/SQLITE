#!/system/bin/sh

ENABLE="$(busybox cat /data/CrossBreeder/SQLITE/ENABLE)"
bootcount="$(busybox cat /data/bootcount)"
CONF="$(busybox cat /data/CrossBreeder/SQLITE/CONF)"

if [ "$ENABLE" = "1" ]; then

flag=false

if [ "$bootcount" -lt "$CONF" ]
then
count=$bootcount
echo "$(( $count + 1 ))" > /data/bootcount
elif [ "$bootcount" -ge "$CONF" ]
then
echo "0" > /data/bootcount
flag=true
else
touch /data/bootcount
echo "0" > /data/bootcount
fi

echo ">SQlite Optimizer"
echo "The system will optimize SQlite databases every $CONF boots."
echo "The system has booted for $bootcount times since the last optimization."

if [ "$flag" == "false" ]
then
echo "The system does not need to optimize databases."
exit 0
elif [ "$flag" == "true" ]
then
echo "The system will optimize databases."

dbcount=0
for db in $(busybox find /data -name *.db)
do
dbcount=$((dbcount+1))
echo ">Optimizing database $dbcount..."
sqlite3 $db 'VACUUM'
sqlite3 $db 'REINDEX'
done
fi

fi
